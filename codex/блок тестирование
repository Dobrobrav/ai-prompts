═══════════════════════════════════════════════════════════════════════════════
7. ТЕСТИРОВАНИЕ
═══════════════════════════════════════════════════════════════════════════════

— Тесты создавай только по моему прямому запросу.

СТРУКТУРА ТЕСТОВ (AAA):
— По умолчанию: Arrange / Act / Assert разделены одной пустой строкой, без комментариев.
— Если внутри секции нужны отступы: добавь комментарий # ARRANGE, # ACT, # ASSERT.
— Act-секция: один вызов (почти всегда одна строка). Если больше — проблема в API.
— Опционально: блок CLEANUP (предложи мне, если целесообразно).

ПРИНЦИПЫ:
— Юнит-тесты = тесты поведения в изоляции (с моками внешних систем).
— Интеграционные = работают с БД/файловой системой/API напрямую.
— Один тест = одна единица поведения (units of behavior), не один метод.
— Тесты должны быть атомарными (разумно, без фанатизма).
— Запускай юнит-тесты после каждого изменения.

ЧТО ЗАПРЕЩЕНО:
— Тестировать приватные методы/атрибуты (это не публичный интерфейс).
— asyncio.run внутри тестов → используй @pytest.mark.asyncio.
— Жёсткие шаблоны нейминга (test_method_does_X) → пиши как факт о поведении.
— Ветвления (if) и множественные блоки одного типа внутри теста.
— Тестировать репозитории напрямую (только в интеграционных тестах).
— Тестировать тривиальные геттеры/сеттеры без бизнес-логики.
— Патчинг (используй только если других вариантов нет).

МОКИРОВАНИЕ И ЗАВИСИМОСТИ:
— Мокируй только управляемые зависимости (managed) — видны вне приложения, часть observable behavior.
— Не мокируй неуправляемые зависимости (БД, доступная только через приложение).
— Никогда не проверяй взаимодействие со стабами (stubs) — они только для эмуляции входящих данных.
— Мокируй последнюю стадию взаимодействия перед выходом из приложения.
— Используй spies вместо моков для edge-классов (шины сообщений и т.п.).

ФИЛОСОФИЯ:
— Black-box тестирование (не знаешь реализацию) вместо white-box.
— Output-based (проверка результата) > state-based (проверка состояния).
— Минимизируй зависимость от деталей реализации (resistance to refactoring).
— Если тест не привязан к бизнес-требованию → признак хрупкости (исключение: утилитарный код).
— Код — нагрузка, а не актив. Делай тесты simple, не усложняй без необходимости.
— Если нужно изменить production-код ради тестов → проконсультируйся со мной.

АРХИТЕКТУРА:
— Разделяй бизнес-логику и оркестровку: код либо работает с out-of-process зависимостями, либо содержит логику, но не оба.
— Границы domain model явные (отдельная сборка/namespace).
— Сокращай слои абстракции (много слоёв усложняют понимание).
— Избегай циклических зависимостей.

